{
  "resourceType": "Questionnaire",
  "id": "e16A-korrektur",
  "meta": {
    "profile": [
      "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-populate"
    ]
  },
  "url": "http://gematik.de/fhir/ti-flow/Questionnaire/e16A-korrektur",
  "version": "1.0.0",
  "title": "Korrektur eines Muster 16",
  "status": "active",
  "experimental": false,
  "date": "2025-08-14",
  "publisher": "gematik GmbH",
  "description": "Questionnaire for requesting corrections to an e16A prescription (Muster 16)",
  "code": [
    {
      "system": "https://gematik.de/fhir/erezept-api-examples/CodeSystem/flow-operation-forms-cs",
      "code": "e16A_Korrektur",
      "display": "Korrektur eines Muster 16"
    }
  ],
  "item": [
    {
      "type": "string",
      "linkId": "patient_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "patient_name"
        }
      ],
      "text": "Name des Patienten",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='Patient').name.where(use='official').first().family + ', ' + %resource.entry.resource.where(resourceType='Patient').name.where(use='official').first().given.first()"
          }
        }
      ]
    },
    {
      "type": "string", 
      "linkId": "patient_kvnr",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "patient_kvnr"
        }
      ],
      "text": "Krankenversichertennummer des Patienten",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='Patient').identifier.where(type.coding.where(code='KVZ10')).first().value"
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "prescription_id",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "prescription_id"
        }
      ],
      "text": "Betreffendes Rezept (Prescription ID)",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression", 
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.identifier.where(system='https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId').value.first()"
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "medication_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "medication_name"
        }
      ],
      "text": "Verordnetes Medikament",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath", 
            "description": "Extract medication name with optional PZN code prefix",
            "expression": "%resource.entry.resource.where(resourceType='Medication').code.text"
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "prescriber_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "prescriber_name"
        }
      ],
      "text": "Name des verordnenden Arztes",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='Practitioner').name.where(use='official').prefix.join(' ') + ' ' + %resource.entry.resource.where(resourceType='Practitioner').name.where(use='official').given.join(' ') + ' ' + %resource.entry.resource.where(resourceType='Practitioner').name.where(use='official').family"
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "prescriber_lanr",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "prescriber_lanr"
        }
      ],
      "text": "LANR des verordnenden Arztes",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='Practitioner').identifier.where(type.coding.code='LANR').value"
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "organization_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "organization_name"
        }
      ],
      "text": "Name der verordnenden Einrichtung",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='Organization').name"
          }
        }
      ]
    },
    {
      "type": "date",
      "linkId": "prescription_date",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "prescription_date"
        }
      ],
      "text": "Verordnungsdatum",
      "required": true,
      "extension": [
        {
          "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
          "valueExpression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.resource.where(resourceType='MedicationRequest').authoredOn"
          }
        }
      ]
    },
    {
      "type": "group",
      "linkId": "change_request",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "change_request"
        }
      ],
      "text": "Gewünschte Medikationsänderung",
      "required": true,
      "item": [
        {
          "type": "string",
          "linkId": "medication",
          "code": [
            {
              "system": "http://gematik.de/CS_e16A_Codes",
              "code": "requested_medication"
            }
          ],
          "text": "Gewünschter Medikamentenname",
          "required": false
        },
        {
          "type": "integer",
          "linkId": "pzn",
          "code": [
            {
              "system": "http://gematik.de/CS_e16A_Codes",
              "code": "requested_pzn"
            }
          ],
          "text": "PZN (Pharmazentralnummer)",
          "required": false
        },
        {
          "type": "string",
          "linkId": "dosage",
          "code": [
            {
              "system": "http://gematik.de/CS_e16A_Codes",
              "code": "requested_dosage"
            }
          ],
          "text": "Gewünschte Dosierung",
          "required": false
        },
        {
          "type": "integer",
          "linkId": "packages",
          "code": [
            {
              "system": "http://gematik.de/CS_e16A_Codes",
              "code": "requested_packages"
            }
          ],
          "text": "Anzahl Packungen",
          "required": false
        }
      ]
    },
    {
      "type": "choice",
      "linkId": "urgency",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "urgency"
        }
      ],
      "text": "Dringlichkeit der Korrektur",
      "required": true,
      "answerValueSet": "#urgency-vs",
      "contained": [
        {
          "resourceType": "ValueSet",
          "id": "urgency-vs",
          "status": "active",
          "compose": {
            "include": [
              {
                "system": "http://gematik.de/CS_e16A_Urgency",
                "concept": [
                  {
                    "code": "routine",
                    "display": "Routine"
                  },
                  {
                    "code": "urgent",
                    "display": "Dringend"
                  },
                  {
                    "code": "emergency",
                    "display": "Notfall"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "type": "string",
      "linkId": "requester_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "requester_name"
        }
      ],
      "text": "Name des Anfragenden (falls abweichend)",
      "required": false
    },
    {
      "type": "string",
      "linkId": "requester_tid",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "requester_tid"
        }
      ],
      "text": "Telematik ID des Anfragenden",
      "required": false
    },
    {
      "type": "string",
      "linkId": "receiver_name",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "receiver_name"
        }
      ],
      "text": "Name des Empfängers",
      "required": false
    },
    {
      "type": "string",
      "linkId": "receiver_tid",
      "code": [
        {
          "system": "http://gematik.de/CS_e16A_Codes",
          "code": "receiver_tid"
        }
      ],
      "text": "Telematik ID des Empfängers",
      "required": false
    }
  ]
}